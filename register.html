<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daftar Akun</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script src="firebase.js"></script>

<link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg, #b84d4d, #e3b57e);
  margin: 0;
  padding: 100px 0;
}

.container {
  max-width: 420px;
  background: #fffaf3;
  padding: 30px;
  margin: auto;
  border-radius: 18px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
}

h2 {
  text-align: center;
  color: #8c1f1f;
  margin-bottom: 20px;
}

label {
  font-weight: 600;
  color: #6d2323;
}

input {
  width: 100%;
  padding: 10px;
  border: 1px solid #e1c7a1;
  border-radius: 8px;
  margin-top: 5px;
  margin-bottom: 15px;
  font-size: 15px;
}

button {
  width: 100%;
  padding: 12px;
  background: #a82828;
  border: none;
  color: white;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.25s;
}

button:hover {
  background: #7c1f1f;
}

.avatar-preview {
  display: block;
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: #8c1f1f;
  color: white;
  font-size: 40px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 15px auto;
  overflow: hidden;
}

#preview-img {
  width: 100%;
  display: none;
}

.crop-area {
  display: none;
  margin-top: 20px;
}

#cropper-image {
  width: 100%;
}

.note {
  text-align: center;
  color: #6d2323;
  margin-top: 20px; !important
  margin-bottom: 5px; !important
  font-size: 14px;
}
</style>
</head>

<body>

<div class="container">
  <h2>Daftar Akun</h2>

  <div class="avatar-preview" id="avatarPreview">A</div>

  <label>Upload Foto Profil (opsional)</label>
  <input type="file" accept="image/*" id="uploadPhoto">

  <!-- Cropper Area -->
  <div class="crop-area" id="cropArea">
    <img id="cropper-image">
    <button id="cropBtn" style="margin-top: 15px;">Crop & Gunakan Foto</button>
  </div>

  <label>Nama Lengkap</label>
  <input type="text" id="name">

  <label>Email</label>
  <input type="email" id="email">

  <label>Password</label>
  <input type="password" id="password">

  <button id="registerBtn">Daftar</button>

  <p class="note">Sudah punya akun? <a href="login.html">Login</a></p>
</div>


<script>
let cropper;
let finalPhotoBlob = null;

document.getElementById("uploadPhoto").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const imgElem = document.getElementById("cropper-image");
  imgElem.src = URL.createObjectURL(file);

  document.getElementById("cropArea").style.display = "block";

  if (cropper) {
    cropper.destroy();
  }

  cropper = new Cropper(imgElem, {
    aspectRatio: 1,
    viewMode: 1,
    background: false
  });
});

document.getElementById("cropBtn").addEventListener("click", async function() {
  if (!cropper) return;

  cropper.getCroppedCanvas({
    width: 400,
    height: 400
  }).toBlob((blob) => {
    finalPhotoBlob = blob;

    const preview = document.getElementById("avatarPreview");
    preview.innerHTML = "";
    preview.style.background = "none";

    const img = document.createElement("img");
    img.src = URL.createObjectURL(blob);
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";
    img.style.borderRadius = "50%";
    preview.appendChild(img);
  });

  document.getElementById("cropArea").style.display = "none";
});

document.getElementById("registerBtn").addEventListener("click", async function() {

  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  if (!name || !email || !password) {
    alert("Mohon isi semua data!");
    return;
  }

  this.disabled = true;
  this.innerText = "Memproses...";

  try {
    const userCred = await auth.createUserWithEmailAndPassword(email, password);
    const uid = userCred.user.uid;

    let photoURL = "";

    if (finalPhotoBlob) {
      photoURL = await uploadCroppedPhoto(uid, finalPhotoBlob);
    }

    await createUserProfile(uid, name, email, photoURL);

    alert("Registrasi berhasil!");
    window.location.href = "profile.html";

  } catch (err) {
    alert("Error: " + err.message);
  }

  this.disabled = false;
  this.innerText = "Daftar";
});

</script>

</body>
</html>